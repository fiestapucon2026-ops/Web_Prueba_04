import crypto from 'crypto';

import { getSessionCookie, verifySessionToken, type AdminRole } from './admin-session';

function timingSafeCompare(a: string, b: string): boolean {
  const ah = crypto.createHash('sha256').update(a).digest('hex');
  const bh = crypto.createHash('sha256').update(b).digest('hex');
  const aBuf = Buffer.from(ah, 'hex');
  const bBuf = Buffer.from(bh, 'hex');
  if (aBuf.length !== bBuf.length) return false;
  return crypto.timingSafeEqual(aBuf, bBuf);
}

/** Verifica clave enviada en body (para login). Devuelve rol o false. */
export function verifyAdminKeyFromBody(key: string): AdminRole | false {
  if (!key || typeof key !== 'string') return false;
  const secret = process.env.ADMIN_SECRET;
  const accessKey = process.env.ACCESS_CONTROL_KEY;
  const cajaKey = process.env.CAJA_KEY;
  if (secret && timingSafeCompare(key, secret)) return 'admin';
  if (accessKey && timingSafeCompare(key, accessKey)) return 'access_control';
  if (cajaKey && timingSafeCompare(key, cajaKey)) return 'caja';
  return false;
}

/**
 * Verifica x-admin-key o cookie de sesi√≥n. Devuelve rol o false.
 */
export function verifyAdminKey(request: Request): AdminRole | false {
  const secret = process.env.ADMIN_SECRET;
  const accessKey = process.env.ACCESS_CONTROL_KEY;
  const cajaKey = process.env.CAJA_KEY;
  if (!secret) return false;

  const headerKey = request.headers.get('x-admin-key');
  if (headerKey !== null && headerKey !== undefined) {
    if (timingSafeCompare(headerKey, secret)) return 'admin';
    if (accessKey && timingSafeCompare(headerKey, accessKey)) return 'access_control';
    if (cajaKey && timingSafeCompare(headerKey, cajaKey)) return 'caja';
  }

  const cookieToken = getSessionCookie(request);
  if (cookieToken) return verifySessionToken(cookieToken);

  return false;
}
