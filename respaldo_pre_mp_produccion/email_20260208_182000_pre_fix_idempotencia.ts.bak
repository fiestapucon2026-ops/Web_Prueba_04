import { Resend } from 'resend';
import type { OrderWithDetails } from './types';
import { requireSupabaseAdmin } from './supabase';

// Validaci√≥n de variable de entorno
const resendApiKey = process.env.RESEND_API_KEY;

// Cliente singleton
let resendClient: Resend | null = null;

if (resendApiKey) {
  resendClient = new Resend(resendApiKey);
} else if (typeof window === 'undefined') {
  console.warn(
    '‚ö†Ô∏è ADVERTENCIA: RESEND_API_KEY no configurado. Las funciones de email no estar√°n disponibles.'
  );
}

// Helper para validar que el cliente est√© inicializado
export function requireResendClient(): Resend {
  if (!resendClient || !resendApiKey) {
    throw new Error(
      'üî¥ ERROR: RESEND_API_KEY no est√° configurado. Configure la variable de entorno en Vercel.'
    );
  }
  return resendClient;
}

// Funci√≥n para enviar email con ticket PDF adjunto
export async function sendTicketEmail(
  order: OrderWithDetails,
  pdfBuffer: Buffer
): Promise<void> {
  const resend = requireResendClient();
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://www.festivalpucon.cl';

  const eventName = order.inventory.event.name;
  const ticketTypeName = order.inventory.ticket_type.name;
  const eventDate = new Date(order.inventory.event.date).toLocaleDateString('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
  const venue = order.inventory.event.venue;

  await resend.emails.send({
    from: 'Festival Puc√≥n <noreply@festivalpucon.cl>', // Ajustar dominio seg√∫n configuraci√≥n
    to: order.user_email,
    subject: `üé´ Tu ticket para ${eventName}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #1e40af;">¬°Gracias por tu compra!</h1>
          <p>Hola,</p>
          <p>Tu pago ha sido confirmado. Adjunto encontrar√°s tu ticket para:</p>
          <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="margin: 5px 0;"><strong>Evento:</strong> ${eventName}</p>
            <p style="margin: 5px 0;"><strong>Tipo:</strong> ${ticketTypeName}</p>
            <p style="margin: 5px 0;"><strong>Fecha:</strong> ${eventDate}</p>
            <p style="margin: 5px 0;"><strong>Lugar:</strong> ${venue}</p>
            <p style="margin: 5px 0;"><strong>Orden:</strong> ${order.external_reference}</p>
          </div>
          <p>Por favor, presenta este ticket (impreso o en tu dispositivo) al ingresar al evento.</p>
          <p>Si tienes alguna pregunta, cont√°ctanos respondiendo a este email.</p>
          <p style="margin-top: 30px; color: #6b7280; font-size: 14px;">
            Festival Puc√≥n 2026<br>
            <a href="${baseUrl}" style="color: #1e40af;">${baseUrl}</a>
          </p>
        </body>
      </html>
    `,
    attachments: [
      {
        filename: `ticket-${order.external_reference}.pdf`,
        content: pdfBuffer,
      },
    ],
  });
}

/** Resumen de √≠tem para el email √∫nico por compra. */
export interface PurchaseItemSummary {
  eventName: string;
  ticketTypeName: string;
  quantity: number;
}

/**
 * Env√≠a un solo email por compra con enlace a "Mis entradas". Opcional: PDF adjunto y/o link a PDF en Storage.
 * Fuente email: payment.payer.email; fallback: orders[0].user_email.
 * 
 * IDEMPOTENCIA: Verifica email_logs antes de enviar para prevenir duplicados.
 * @param externalReference - UUID del external_reference de la compra (para idempotencia)
 */
export async function sendPurchaseEmail(
  to: string,
  accessToken: string,
  itemsSummary: PurchaseItemSummary[],
  externalReference: string,
  pdfBuffer?: Buffer,
  pdfUrl?: string
): Promise<void> {
  const supabase = requireSupabaseAdmin();
  const subject = 'Tu compra ‚Äî Festival Puc√≥n 2026';

  // IDEMPOTENCIA: Verificar si ya se envi√≥ email para esta compra en la √∫ltima hora
  // Previene emails duplicados en caso de webhooks concurrentes o reintentos del worker
  const { data: recentLog, error: logCheckErr } = await supabase
    .from('email_logs')
    .select('id, created_at')
    .eq('to_email', to)
    .eq('subject', subject)
    .gte('created_at', new Date(Date.now() - 3600000).toISOString()) // √∫ltima hora
    .order('created_at', { ascending: false })
    .limit(1);

  if (logCheckErr) {
    console.error('[sendPurchaseEmail] Error al verificar email_logs:', logCheckErr);
    // Continuar de todas formas (mejor enviar duplicado que no enviar)
  } else if (recentLog && recentLog.length > 0) {
    console.log(
      `[sendPurchaseEmail] Idempotencia: email ya enviado a ${to} hace ${Math.floor((Date.now() - new Date(recentLog[0].created_at).getTime()) / 1000)}s. Ref: ${externalReference}`
    );
    return; // ‚Üê Skip env√≠o
  }

  const resend = requireResendClient();
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://www.festivalpucon.cl';
  const misEntradasUrl = `${baseUrl}/mis-entradas?token=${encodeURIComponent(accessToken)}`;

  const itemsHtml = itemsSummary
    .map(
      (i) =>
        `<li style="margin: 4px 0;">${i.quantity}x ${i.ticketTypeName} ‚Äî ${i.eventName}</li>`
    )
    .join('');

  const pdfLinkHtml =
    pdfUrl != null && pdfUrl !== ''
      ? `<p style="margin-top: 16px;"><a href="${pdfUrl}" style="color: #1e40af;">Descargar PDF de entradas</a></p>`
      : '';

  const attachments = pdfBuffer
    ? [
        {
          filename: 'entradas-festival-pucon.pdf',
          content: pdfBuffer,
        },
      ]
    : [];

  try {
    await resend.emails.send({
      from: 'Festival Puc√≥n <noreply@festivalpucon.cl>',
      to,
      subject,
      html: `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <h1 style="color: #1e40af;">¬°Gracias por tu compra!</h1>
            <p>Tu pago ha sido confirmado. Resumen de tu compra:</p>
            <ul style="list-style: none; padding-left: 0;">
              ${itemsHtml}
            </ul>
            <p style="margin-top: 24px;">
              <a href="${misEntradasUrl}" style="display: inline-block; background-color: #1e40af; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">Ver y descargar mis entradas</a>
            </p>
            ${pdfLinkHtml}
            <p style="color: #6b7280; font-size: 14px;">El enlace es v√°lido 7 d√≠as. Presenta tu entrada (impresa o en tu dispositivo) al ingresar al evento.</p>
            <p style="margin-top: 30px; color: #6b7280; font-size: 14px;">
              Festival Puc√≥n 2026<br>
              <a href="${baseUrl}" style="color: #1e40af;">${baseUrl}</a>
            </p>
          </body>
        </html>
      `,
      attachments,
    });

    // Registrar env√≠o exitoso en email_logs (auditoria + idempotencia)
    const { error: logInsertErr } = await supabase.from('email_logs').insert({
      order_id: null, // Opcional: si hay 1 orden principal, usar su UUID
      status: 'SENT',
      to_email: to,
      subject,
      error_message: null,
    });

    if (logInsertErr) {
      console.error('[sendPurchaseEmail] Error al registrar en email_logs:', logInsertErr);
      // No lanzar error: el email ya se envi√≥ exitosamente
    } else {
      console.log(`[sendPurchaseEmail] Email enviado y registrado: ${to} (ref: ${externalReference})`);
    }
  } catch (emailErr) {
    // Registrar fallo en email_logs
    const errorMsg = emailErr instanceof Error ? emailErr.message : String(emailErr);
    console.error('[sendPurchaseEmail] Error al enviar email:', errorMsg);

    await supabase.from('email_logs').insert({
      order_id: null,
      status: 'FAILED',
      to_email: to,
      subject,
      error_message: errorMsg.substring(0, 500), // Limitar longitud
    });

    throw emailErr; // Re-lanzar para que el worker marque el job como failed
  }
}
